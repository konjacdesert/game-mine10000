(()=>{"use strict";class t{constructor(t,e,s){s?this.display=s:(this.display=document.createElement("canvas").getContext("2d"),document.body.appendChild(this.display.canvas)),e=(t=t<=0?100:t)<=0?100:e,this.display.canvas.width=t,this.display.canvas.height=e,this.display.canvas.oncontextmenu=function(){return!1},this.display.canvas.onclick=function(){return!1},this.display.canvas.onmousedown=function(){return!1},this.display.canvas.onmouseup=function(){return!1},this.display.canvas.ondblclick=function(){return console.log("dbl"),!1},this.buffer=document.createElement("canvas").getContext("2d"),this.buffer.canvas.width=t,this.buffer.canvas.height=e,this.buffer.imageSmoothingEnabled=!1,this.clearBuffer(),this.updateDisp()}get(t){return"buffer"==t?this.buffer:this.display}clearBuffer(){this.buffer.resetTransform(),this.buffer.fillStyle="#fff",this.buffer.fillRect(0,0,this.buffer.canvas.width,this.buffer.canvas.height)}updateDisp(){this.display.drawImage(this.buffer.canvas,0,0)}}class e{constructor(){this.data=[],this.checked2=[],this.drawUpdateList=[];for(let t=0;t<e.C.columns*e.C.rows;t++)this.data.push(0),this.checked2.push(0)}getState(){return this.state}getCellData(){let t=0,s=0;return this.checked2.forEach((e=>{e<0?s++:e>0&&t++})),{flag:s,checked:t,left:e.C.columns*e.C.rows-e.C.numMine-t,flagLeft:e.C.numMine-s}}clear(){this.state="start",this.drawUpdateList=[];for(let t=0;t<e.C.columns*e.C.rows;t++)this.checked2[t]=0}setMine(t,s){this.state="ingame";for(let t=0;t<e.C.columns*e.C.rows;t++)this.data[t]=0;let i=0;for(;i<e.C.numMine;){let a=Math.random()*e.C.columns|0,l=Math.random()*e.C.rows|0;t-1<=a&&a<=t+1&&s-1<=l&&l<=s+1||this.getRawData(a,l)>=0&&(this.setRawData(a,l,-1),this.around(a,l,((t,e)=>{this.getRawData(t,e)>=0&&this.addRawData(t,e,1)})),i++)}}around(t,e,s){for(let i=-1;i<=1;i++)for(let a=-1;a<=1;a++)0==a&&0==i||this.isRangeOut(t+a,e+i)||s(t+a,e+i)}isRangeOut(t,s){return t<0||t>=e.C.columns||s<0||s>=e.C.rows}getRawData(t,s){return this.isRangeOut(t,s)?0:this.data[t+s*e.C.columns]}setRawData(t,s,i){this.isRangeOut(t,s)||(this.data[t+s*e.C.columns]=i)}addRawData(t,s,i){this.isRangeOut(t,s)||(this.data[t+s*e.C.columns]+=i)}isOpen(t,s){return!!this.isRangeOut(t,s)||this.checked2[t+s*e.C.columns]>0}isFlagged(t,s){return!this.isRangeOut(t,s)&&this.checked2[t+s*e.C.columns]<0}isPlain(t,s){return!this.isRangeOut(t,s)&&0==this.checked2[t+s*e.C.columns]}setFlag(t,s,i){return!this.isOpen(t,s)&&(this.checked2[t+s*e.C.columns]=i?-1:0,this.addUpdateList(t,s),!0)}addUpdateList(t,s){this.drawUpdateList.push(t+s*e.C.columns)}dig(t,s){return!!this.isPlain(t,s)&&(this.checked2[t+s*e.C.columns]=1,this.addUpdateList(t,s),!0)}digLoop(t,e){const s=[];for(s.push({x:t,y:e});s.length>0;){const t=s.shift();0!=this.dig(t.x,t.y)&&(0==this.getRawData(t.x,t.y)?this.around(t.x,t.y,((t,e)=>{s.push({x:t,y:e})})):this.getRawData(t.x,t.y)<0&&(this.state="stop"))}0==this.getCellData().left&&(this.state="stop")}flipFlag(t,e){this.setFlag(t,e,!this.isFlagged(t,e))}yoshinaniDigFlag(t,e){if(!this.isFlagged(t,e)&&this.isOpen(t,e)){const s=this.getRawData(t,e);if(s>0){const i=[],a=[];this.around(t,e,((t,e)=>{this.isPlain(t,e)&&i.push({x:t,y:e}),this.isFlagged(t,e)&&a.push({x:t,y:e})})),s==a.length&&i.forEach((t=>{this.digLoop(t.x,t.y)})),s==i.length+a.length&&i.forEach((t=>{this.setFlag(t.x,t.y,!0)}))}}}drawBase(t){t.clearRect(0,0,t.canvas.width,t.canvas.height),t.fillStyle=e.C.color.close,t.fillRect(0,0,t.canvas.width,t.canvas.height),t.fillStyle=e.C.color.line;for(let s=0;s<e.C.columns;s++)t.fillRect(s*e.C.cell.width,0,1,t.canvas.height);for(let s=0;s<e.C.rows;s++)t.fillRect(0,s*e.C.cell.height,t.canvas.width,1)}drawBmp(t,s,i,a){e.cellBMP[a]&&(s+=e.cellBMP[a].left,i+=e.cellBMP[a].top,e.cellBMP[a].bmp.forEach(((e,a)=>{e.forEach(((e,l)=>{e&&t.fillRect(s+l,i+a,1,1)}))})))}draw(t,s,i){this.isOpen(s,i)?(t.fillStyle=e.C.color.open,t.fillRect(s*e.C.cell.width+1,i*e.C.cell.height+1,e.C.cell.width-1,e.C.cell.height-1),this.getRawData(s,i)<0?(t.fillStyle=e.C.color.mine,this.drawBmp(t,s*e.C.cell.width,i*e.C.cell.height,9)):this.getRawData(s,i)>0&&(t.fillStyle=e.C.color.near,this.drawBmp(t,s*e.C.cell.width,i*e.C.cell.height,this.getRawData(s,i)))):(t.fillStyle=e.C.color.close,t.fillRect(s*e.C.cell.width+1,i*e.C.cell.height+1,e.C.cell.width-1,e.C.cell.height-1),this.isFlagged(s,i)&&(t.fillStyle=e.C.color.flag,this.drawBmp(t,s*e.C.cell.width,i*e.C.cell.height,10)))}yoshinaniUpdate(){for(const t of this.drawUpdateList){const s=t%e.C.columns,i=t/e.C.columns|0;this.yoshinaniDigFlag(s,i),this.around(s,i,((t,e)=>{this.yoshinaniDigFlag(t,e)}))}}drawUpdate(t){for(;this.drawUpdateList.length>0;){const s=this.drawUpdateList.shift(),i=s%e.C.columns,a=s/e.C.columns|0;this.draw(t,i,a)}}drawAll(t){for(let s=0;s<e.C.rows;s++)for(let i=0;i<e.C.columns;i++)this.draw(t,i,s)}}e.C={rows:100,columns:100,numMine:1500,cell:{width:8,height:8},color:{close:"#ddd",open:"#fff",line:"#bbb",mine:"#f00",flag:"#006",near:"#000"}},e.cellBMP=[{top:2,left:3,bmp:[[1,1,1],[1,0,1],[1,0,1],[1,0,1],[1,1,1]]},{top:2,left:4,bmp:[[1],[1],[1],[1],[1]]},{top:2,left:3,bmp:[[1,1,1],[0,0,1],[1,1,1],[1,0,0],[1,1,1]]},{top:2,left:3,bmp:[[1,1,1],[0,0,1],[1,1,1],[0,0,1],[1,1,1]]},{top:2,left:3,bmp:[[1,0,1],[1,0,1],[1,1,1],[0,0,1],[0,0,1]]},{top:2,left:3,bmp:[[1,1,1],[1,0,0],[1,1,1],[0,0,1],[1,1,1]]},{top:2,left:3,bmp:[[1,1,1],[1,0,0],[1,1,1],[1,0,1],[1,1,1]]},{top:2,left:3,bmp:[[1,1,1],[1,0,1],[0,0,1],[0,0,1],[0,0,1]]},{top:2,left:3,bmp:[[1,1,1],[1,0,1],[1,1,1],[1,0,1],[1,1,1]]},{top:2,left:2,bmp:[[1,0,1,0,1],[0,1,1,1],[1,1,1,1,1],[0,1,1,1],[1,0,1,0,1]]},{top:2,left:2,bmp:[[1,1,1],[1,1,1],[0,0,1],[0,1,1,1],[1,1,1,1,1]]}];class s{constructor(t){this.callback=t}start(){this.startTime=performance.now(),this.lastTime=this.startTime,this.tick()}stop(){cancelAnimationFrame(this.id)}getMs(){return this.lastTime-this.startTime}getSec(){return this.getMs()/1e3|0}tick(){this.id=requestAnimationFrame(this.tick.bind(this)),this.lastTime=performance.now(),this.getSec()!=this.tmpSec&&(this.tmpSec=this.getSec(),this.callback())}}const i=function(){let i,a,l;function n(){a.clear(),a.drawBase(i.get("buffer")),i.updateDisp(),l.stop()}function h(t){n()}function c(t){if("stop"==a.getState())return;const s=(t.offsetX+.5)/e.C.cell.width|0,n=(t.offsetY+.5)/e.C.cell.height|0;switch(t.buttons){case 1:if(!t.shiftKey){"start"==a.getState()&&(a.setMine(s,n),l.start()),h=s,c=n,a.digLoop(h,c);break}case 3:case 4:!function(t,e){"ingame"==a.getState()&&a.yoshinaniDigFlag(t,e)}(s,n);break;case 2:!function(t,e){"ingame"==a.getState()&&a.flipFlag(t,e)}(s,n)}var h,c;document.getElementById("cheat").checked&&a.yoshinaniUpdate(),document.getElementById("flag").value=a.getCellData().flagLeft.toFixed(0),"stop"==a.getState()&&(l.stop(),0==a.getCellData().left&&setTimeout((()=>{alert("Great work!")}),100)),a.drawUpdate(i.get("buffer")),i.updateDisp()}function o(){document.getElementById("time").value=l.getSec().toFixed(0)}return{start:function(){const r=e.C.columns*e.C.cell.width,d=e.C.rows*e.C.cell.height;i=new t(r,d,document.getElementById("game").getContext("2d")),a=new e,l=new s(o),i.get("display").canvas.addEventListener("mousedown",c),document.getElementById("reset").addEventListener("click",h),n()}}}();window.addEventListener("load",i.start)})();